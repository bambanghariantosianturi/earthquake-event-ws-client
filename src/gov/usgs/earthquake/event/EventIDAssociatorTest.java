package gov.usgs.earthquake.event;

import java.math.BigDecimal;
import java.math.MathContext;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import junit.framework.Assert;

import org.junit.Before;
import org.junit.Test;

/**
 * Tests for EventIDAssociator.
 */
public class EventIDAssociatorTest {

	private EventIDAssociator testAssociator;
	private TestEventWebService testService;

	private static final BigDecimal MAGNITUDE_DIFFERENCE = new BigDecimal(".567");
	private static final BigDecimal DEPTH_DIFFERENCE = new BigDecimal("13.2");

	@Before
	public void setup() {
		testService = new TestEventWebService();
		testAssociator = new EventIDAssociator(testService, new EventComparison(
				EventIDAssociator.DEFAULT_TIME_DIFFERENCE,
				EventIDAssociator.DEFAULT_LOCATION_DIFFERENCE, MAGNITUDE_DIFFERENCE,
				DEPTH_DIFFERENCE), new EventSanityCheck());
	}

	/**
	 * Check the nearby queries generated by event id associator match
	 * expectations.
	 * 
	 * @throws Exception
	 */
	@Test
	public void testNearbyQuery() throws Exception {
		DefaultEventInfo event = new DefaultEventInfo();
		event.setTime(new Date());
		event.setLatitude(new BigDecimal("34"));
		event.setLongitude(new BigDecimal("-118"));
		event.setDepth(new BigDecimal("1.32"));
		event.setMagnitude(new BigDecimal("4.5"));

		EventQuery query;
		EventComparison criteria = testAssociator.getNearbyCriteria();

		testAssociator.getNearbyEvents(event, null);
		query = testService.lastQuery;
		long milliseconds = testAssociator.getNearbyCriteria().getTimeDifference()
				.multiply(new BigDecimal("1000")).longValue();
		Assert.assertEquals("expected start time", query.getStartTime(), new Date(
				event.getTime().getTime() - milliseconds));
		Assert.assertEquals("expected end time", query.getEndTime(), new Date(event
				.getTime().getTime() + milliseconds));
		Assert.assertEquals("expected latitude", event.getLatitude(),
				query.getLatitude());
		Assert.assertEquals("expected longitude", event.getLongitude(),
				query.getLongitude());
		Assert.assertEquals(
				"expected radius",
				criteria.getLocationDifference().divide(
						EventIDAssociator.KILOMETERS_PER_DEGREE, MathContext.DECIMAL32),
				query.getMaxRadius());
		Assert.assertEquals("expected min depth",
				event.getDepth().subtract(criteria.getDepthDifference()),
				query.getMinDepth());
		Assert.assertEquals("expected max depth",
				event.getDepth().add(criteria.getDepthDifference()),
				query.getMaxDepth());
		Assert.assertEquals("expected min magnitude", event.getMagnitude()
				.subtract(criteria.getMagnitudeDifference()), query.getMinMagnitude());
		Assert.assertEquals("expected max magnitude",
				event.getMagnitude().add(criteria.getMagnitudeDifference()),
				query.getMaxMagnitude());

		Assert.assertNull("expected null network", query.getCatalog());

		testAssociator.getNearbyEvents(event, "testnetwork");
		query = testService.lastQuery;
		Assert.assertEquals("expected null network", "testnetwork",
				query.getCatalog());

		try {
			testAssociator.getNearbyEvents(new DefaultEventInfo(), null);
			Assert.fail("empty event should throw exception");
		} catch (IllegalArgumentException iae) {
			// expected
		}
	}

	/**
	 * Test event web service that returns empty list of events, and captures
	 * queries for inspection.
	 */
	public static class TestEventWebService extends EventWebService {

		public TestEventWebService() {
			super(null);
		}

		public EventQuery lastQuery = null;

		@Override
		public List<JsonEvent> getEvents(final EventQuery query) {
			this.lastQuery = query;
			return new ArrayList<JsonEvent>();
		}

	}

}
